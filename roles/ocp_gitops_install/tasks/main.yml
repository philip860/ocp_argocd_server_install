---
###########################################################################
# Ensure operator namespace exists (where Subscription lives)
###########################################################################
- name: "Ensure operator namespace '{{ ocp_gitops_operator_namespace }}' exists"
  kubernetes.core.k8s:
    kubeconfig: "{{ ocp_kubeconfig }}"
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ ocp_gitops_operator_namespace }}"

###########################################################################
# OperatorGroup (in operator namespace)
###########################################################################
- name: "Create OperatorGroup for GitOps operator"
  kubernetes.core.k8s:
    kubeconfig: "{{ ocp_kubeconfig }}"
    state: present
    definition:
      apiVersion: operators.coreos.com/v1
      kind: OperatorGroup
      metadata:
        name: gitops-operator-group
        namespace: "{{ ocp_gitops_operator_namespace }}"
      spec:
        targetNamespaces: []  # empty = cluster-wide (recommended for GitOps)

###########################################################################
# Subscription for OpenShift GitOps operator
###########################################################################
- name: "Subscribe to OpenShift GitOps operator"
  kubernetes.core.k8s:
    kubeconfig: "{{ ocp_kubeconfig }}"
    state: present
    definition:
      apiVersion: operators.coreos.com/v1alpha1
      kind: Subscription
      metadata:
        name: "{{ ocp_gitops_operator_name }}"
        namespace: "{{ ocp_gitops_operator_namespace }}"
      spec:
        channel: "{{ ocp_gitops_operator_channel }}"
        name: "{{ ocp_gitops_operator_name }}"
        source: "{{ ocp_gitops_operator_source }}"
        sourceNamespace: "{{ ocp_gitops_operator_source_namespace }}"
        installPlanApproval: Automatic

###########################################################################
# Wait for operator CSV (normal run) / inspect in check mode
###########################################################################
- name: "Wait for GitOps operator CSV to be Succeeded"
  kubernetes.core.k8s_info:
    kubeconfig: "{{ ocp_kubeconfig }}"
    api_version: operators.coreos.com/v1alpha1
    kind: ClusterServiceVersion
    namespace: "{{ ocp_gitops_operator_namespace }}"
  register: ocp_gitops_csvs
  retries: "{{ ocp_gitops_wait_retries }}"
  delay: "{{ ocp_gitops_wait_delay }}"
  until: >
    (
      ocp_gitops_csvs.resources
      | selectattr('metadata.name', 'search', ocp_gitops_operator_name)
      | selectattr('status.phase', 'equalto', 'Succeeded')
      | list
      | length
    ) > 0
  when: not ansible_check_mode

- name: "Check mode: show existing GitOps operator CSVs (no wait)"
  kubernetes.core.k8s_info:
    kubeconfig: "{{ ocp_kubeconfig }}"
    api_version: operators.coreos.com/v1alpha1
    kind: ClusterServiceVersion
    namespace: "{{ ocp_gitops_operator_namespace }}"
  register: ocp_gitops_csvs_check
  when: ansible_check_mode
  changed_when: false

- name: "Check mode: print GitOps CSV names"
  ansible.builtin.debug:
    msg: >-
      Existing GitOps CSVs in {{ ocp_gitops_operator_namespace }}:
      {{ ocp_gitops_csvs_check.resources | map(attribute='metadata.name') | list }}
  when: ansible_check_mode
  changed_when: false

###########################################################################
# Wait for operator to create the default namespace 'openshift-gitops'
###########################################################################
- name: "Wait for default GitOps namespace '{{ ocp_gitops_instance_namespace }}' to be created by operator"
  kubernetes.core.k8s_info:
    kubeconfig: "{{ ocp_kubeconfig }}"
    api_version: v1
    kind: Namespace
    name: "{{ ocp_gitops_instance_namespace }}"
  register: ocp_gitops_ns_info
  retries: "{{ ocp_gitops_wait_retries }}"
  delay: "{{ ocp_gitops_wait_delay }}"
  until: ocp_gitops_ns_info.resources | length > 0
  when: not ansible_check_mode

- name: "Check mode: show if default GitOps namespace exists"
  kubernetes.core.k8s_info:
    kubeconfig: "{{ ocp_kubeconfig }}"
    api_version: v1
    kind: Namespace
    name: "{{ ocp_gitops_instance_namespace }}"
  register: ocp_gitops_ns_info_check
  when: ansible_check_mode
  changed_when: false

- name: "Check mode: print namespace existence info"
  ansible.builtin.debug:
    msg: >-
      Namespace '{{ ocp_gitops_instance_namespace }}' exists:
      {{ (ocp_gitops_ns_info_check.resources | length) > 0 }}
  when: ansible_check_mode
  changed_when: false

###########################################################################
# Wait for default ArgoCD instance (created automatically by operator)
###########################################################################
- name: "Wait for default Argo CD instance '{{ ocp_gitops_instance_name }}' in '{{ ocp_gitops_instance_namespace }}'"
  kubernetes.core.k8s_info:
    kubeconfig: "{{ ocp_kubeconfig }}"
    api_version: argoproj.io/v1beta1
    kind: ArgoCD
    namespace: "{{ ocp_gitops_instance_namespace }}"
    name: "{{ ocp_gitops_instance_name }}"
  register: ocp_gitops_argocd_info
  retries: "{{ ocp_gitops_wait_retries }}"
  delay: "{{ ocp_gitops_wait_delay }}"
  until: ocp_gitops_argocd_info.resources | length > 0
  when: not ansible_check_mode

- name: "Check mode: look for default Argo CD instance (no wait)"
  kubernetes.core.k8s_info:
    kubeconfig: "{{ ocp_kubeconfig }}"
    api_version: argoproj.io/v1beta1
    kind: ArgoCD
    namespace: "{{ ocp_gitops_instance_namespace }}"
    name: "{{ ocp_gitops_instance_name }}"
  register: ocp_gitops_argocd_info_check
  when: ansible_check_mode
  changed_when: false

- name: "Check mode: print Argo CD instance existence info"
  ansible.builtin.debug:
    msg: >-
      Default Argo CD instance '{{ ocp_gitops_instance_name }}'
      in namespace '{{ ocp_gitops_instance_namespace }}' exists:
      {{ (ocp_gitops_argocd_info_check.resources | length) > 0 }}
  when: ansible_check_mode
  changed_when: false

###########################################################################
# Wait for Argo CD server deployment to be available ("stand up the server")
###########################################################################
- name: "Wait for Argo CD server Deployment to be available"
  kubernetes.core.k8s_info:
    kubeconfig: "{{ ocp_kubeconfig }}"
    api_version: apps/v1
    kind: Deployment
    namespace: "{{ ocp_gitops_instance_namespace }}"
    name: "{{ ocp_gitops_instance_name }}-server"
  register: ocp_gitops_server_deploy
  retries: "{{ ocp_gitops_wait_retries }}"
  delay: "{{ ocp_gitops_wait_delay }}"
  until: >
    ocp_gitops_server_deploy.resources | length > 0 and
    (ocp_gitops_server_deploy.resources[0].status.readyReplicas | default(0) | int) > 0
  when: not ansible_check_mode

- name: "Check mode: get Argo CD server deployment (no wait)"
  kubernetes.core.k8s_info:
    kubeconfig: "{{ ocp_kubeconfig }}"
    api_version: apps/v1
    kind: Deployment
    namespace: "{{ ocp_gitops_instance_namespace }}"
    name: "{{ ocp_gitops_instance_name }}-server"
  register: ocp_gitops_server_deploy_check
  when: ansible_check_mode
  changed_when: false

###########################################################################
# Route + login info (once server is up)
###########################################################################
- name: "Get Argo CD route"
  kubernetes.core.k8s_info:
    kubeconfig: "{{ ocp_kubeconfig }}"
    api_version: route.openshift.io/v1
    kind: Route
    namespace: "{{ ocp_gitops_instance_namespace }}"
    name: "{{ ocp_gitops_instance_name }}-server"
  register: ocp_gitops_route
  when: not ansible_check_mode

- name: "Show Argo CD URL and admin login hint"
  ansible.builtin.debug:
    msg:
      - "Argo CD Route: https://{{ ocp_gitops_route.resources[0].spec.host }}"
      - "Username: admin (for the default instance)"
      - >-
        Password: check the secret '{{ ocp_gitops_instance_name }}-cluster'
        in namespace '{{ ocp_gitops_instance_namespace }}' (key: admin.password).
  when: not ansible_check_mode
