---
###########################################################################
# 0) Preflight: fail if a community ArgoCD operator is installed
#    (we only want Red Hat OpenShift GitOps: openshift-gitops-operator)
###########################################################################
- name: "Preflight: find subscriptions that look like community ArgoCD operators"
  kubernetes.core.k8s_info:
    kubeconfig: "{{ ocp_kubeconfig }}"
    api_version: operators.coreos.com/v1alpha1
    kind: Subscription
  register: ocp_gitops_all_subs

- name: "Preflight: fail if non-RedHat ArgoCD operators are present"
  ansible.builtin.fail:
    msg: >-
      Found Subscriptions that look like community ArgoCD operators (not Red Hat
      OpenShift GitOps). Please uninstall these before running this role to avoid
      OLM 'intersecting operatorgroups provide the same apis' conflicts.

      Offending Subscriptions:
      {{ bad_subs | map('to_json') | join('\n') }}
  vars:
    bad_subs: >-
      {{
        ocp_gitops_all_subs.resources
        | selectattr('spec.name', 'defined')
        | selectattr('spec.name', 'match', 'argocd')
        | rejectattr('spec.name', 'equalto', ocp_gitops_operator_name)
        | list
      }}
  when: bad_subs | length > 0

###########################################################################
# 1) Ensure operator namespace exists (where Subscription & OperatorGroup live)
###########################################################################
- name: "Create operator namespace '{{ ocp_gitops_operator_namespace }}' (if allowed)"
  kubernetes.core.k8s:
    kubeconfig: "{{ ocp_kubeconfig }}"
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ ocp_gitops_operator_namespace }}"
  when: not ansible_check_mode
  register: ocp_gitops_operator_ns_create
  failed_when: >
    ocp_gitops_operator_ns_create.failed and
    (
      'Forbidden' not in (ocp_gitops_operator_ns_create.msg | default('')) and
      'forbidden' not in (ocp_gitops_operator_ns_create.msg | default(''))
    )

- name: "Fail if operator namespace is missing and cannot be created by this ServiceAccount"
  ansible.builtin.fail:
    msg: >-
      Namespace '{{ ocp_gitops_operator_namespace }}' does not exist and could not be
      created using the current credentials. Per Red Hat docs, you must create it once
      as a cluster-admin, e.g.:

        oc create namespace {{ ocp_gitops_operator_namespace }}
  when: >
    not ansible_check_mode and
    ocp_gitops_operator_ns_create is defined and
    ocp_gitops_operator_ns_create.failed and
    (
      'Forbidden' in (ocp_gitops_operator_ns_create.msg | default('')) or
      'forbidden' in (ocp_gitops_operator_ns_create.msg | default(''))
    )

- name: "Wait for operator namespace '{{ ocp_gitops_operator_namespace }}' to exist"
  kubernetes.core.k8s_info:
    kubeconfig: "{{ ocp_kubeconfig }}"
    api_version: v1
    kind: Namespace
    name: "{{ ocp_gitops_operator_namespace }}"
  register: ocp_gitops_operator_ns_info
  retries: "{{ ocp_gitops_wait_retries }}"
  delay: "{{ ocp_gitops_wait_delay }}"
  until: ocp_gitops_operator_ns_info.resources | length > 0
  when: not ansible_check_mode

- name: "Check mode: show if operator namespace exists"
  kubernetes.core.k8s_info:
    kubeconfig: "{{ ocp_kubeconfig }}"
    api_version: v1
    kind: Namespace
    name: "{{ ocp_gitops_operator_namespace }}"
  register: ocp_gitops_operator_ns_info_check
  when: ansible_check_mode
  changed_when: false

- name: "Check mode: print operator namespace existence info"
  ansible.builtin.debug:
    msg: >-
      Operator namespace '{{ ocp_gitops_operator_namespace }}' exists:
      {{ (ocp_gitops_operator_ns_info_check.resources | length) > 0 }}
  when: ansible_check_mode
  changed_when: false

###########################################################################
# 2) OperatorGroup in operator namespace (Red Hat GitOps operator only)
###########################################################################
- name: "Create OperatorGroup for Red Hat OpenShift GitOps operator"
  kubernetes.core.k8s:
    kubeconfig: "{{ ocp_kubeconfig }}"
    state: present
    definition:
      apiVersion: operators.coreos.com/v1
      kind: OperatorGroup
      metadata:
        name: gitops-operator-group
        namespace: "{{ ocp_gitops_operator_namespace }}"
      spec:
        # Empty targetNamespaces = cluster-wide, which is recommended for GitOps
        targetNamespaces: []

###########################################################################
# 3) Subscription for Red Hat OpenShift GitOps operator
###########################################################################
- name: "Subscribe to Red Hat OpenShift GitOps operator"
  kubernetes.core.k8s:
    kubeconfig: "{{ ocp_kubeconfig }}"
    state: present
    definition:
      apiVersion: operators.coreos.com/v1alpha1
      kind: Subscription
      metadata:
        name: "{{ ocp_gitops_operator_name }}"
        namespace: "{{ ocp_gitops_operator_namespace }}"
      spec:
        channel: "{{ ocp_gitops_operator_channel }}"
        name: "{{ ocp_gitops_operator_name }}"
        source: "{{ ocp_gitops_operator_source }}"
        sourceNamespace: "{{ ocp_gitops_operator_source_namespace }}"
        installPlanApproval: Automatic

###########################################################################
# 4) Wait for GitOps operator CSV (normal run) / inspect in check mode
###########################################################################
- name: "Wait for GitOps operator CSV to be Succeeded"
  kubernetes.core.k8s_info:
    kubeconfig: "{{ ocp_kubeconfig }}"
    api_version: operators.coreos.com/v1alpha1
    kind: ClusterServiceVersion
    namespace: "{{ ocp_gitops_operator_namespace }}"
  register: ocp_gitops_csvs
  retries: "{{ ocp_gitops_wait_retries }}"
  delay: "{{ ocp_gitops_wait_delay }}"
  until: >
    (
      ocp_gitops_csvs.resources
      | selectattr('metadata.name', 'search', ocp_gitops_operator_name)
      | selectattr('status.phase', 'equalto', 'Succeeded')
      | list
      | length
    ) > 0
  when: not ansible_check_mode

- name: "Check mode: show existing GitOps operator CSVs (no wait)"
  kubernetes.core.k8s_info:
    kubeconfig: "{{ ocp_kubeconfig }}"
    api_version: operators.coreos.com/v1alpha1
    kind: ClusterServiceVersion
    namespace: "{{ ocp_gitops_operator_namespace }}"
  register: ocp_gitops_csvs_check
  when: ansible_check_mode
  changed_when: false

- name: "Check mode: print GitOps CSV names"
  ansible.builtin.debug:
    msg: >-
      Existing GitOps CSVs in {{ ocp_gitops_operator_namespace }}:
      {{ ocp_gitops_csvs_check.resources | map(attribute='metadata.name') | list }}
  when: ansible_check_mode
  changed_when: false

###########################################################################
# 5) Wait for default GitOps namespace 'openshift-gitops' created by operator
###########################################################################
- name: "Wait for default GitOps namespace '{{ ocp_gitops_instance_namespace }}' to be created by operator"
  kubernetes.core.k8s_info:
    kubeconfig: "{{ ocp_kubeconfig }}"
    api_version: v1
    kind: Namespace
    name: "{{ ocp_gitops_instance_namespace }}"
  register: ocp_gitops_ns_info
  retries: "{{ ocp_gitops_wait_retries }}"
  delay: "{{ ocp_gitops_wait_delay }}"
  until: ocp_gitops_ns_info.resources | length > 0
  when: not ansible_check_mode

- name: "Check mode: show if default GitOps namespace exists"
  kubernetes.core.k8s_info:
    kubeconfig: "{{ ocp_kubeconfig }}"
    api_version: v1
    kind: Namespace
    name: "{{ ocp_gitops_instance_namespace }}"
  register: ocp_gitops_ns_info_check
  when: ansible_check_mode
  changed_when: false

- name: "Check mode: print namespace existence info"
  ansible.builtin.debug:
    msg: >-
      Namespace '{{ ocp_gitops_instance_namespace }}' exists:
      {{ (ocp_gitops_ns_info_check.resources | length) > 0 }}
  when: ansible_check_mode
  changed_when: false

###########################################################################
# 6) Wait for default ArgoCD instance (created automatically by GitOps operator)
###########################################################################
- name: "Wait for default Argo CD instance '{{ ocp_gitops_instance_name }}' in '{{ ocp_gitops_instance_namespace }}'"
  kubernetes.core.k8s_info:
    kubeconfig: "{{ ocp_kubeconfig }}"
    api_version: argoproj.io/v1beta1
    kind: ArgoCD
    namespace: "{{ ocp_gitops_instance_namespace }}"
    name: "{{ ocp_gitops_instance_name }}"
  register: ocp_gitops_argocd_info
  retries: "{{ ocp_gitops_wait_retries }}"
  delay: "{{ ocp_gitops_wait_delay }}"
  until: ocp_gitops_argocd_info.resources | length > 0
  when: not ansible_check_mode

- name: "Check mode: look for default Argo CD instance (no wait)"
  kubernetes.core.k8s_info:
    kubeconfig: "{{ ocp_kubeconfig }}"
    api_version: argoproj.io/v1beta1
    kind: ArgoCD
    namespace: "{{ ocp_gitops_instance_namespace }}"
    name: "{{ ocp_gitops_instance_name }}"
  register: ocp_gitops_argocd_info_check
  when: ansible_check_mode
  changed_when: false

- name: "Check mode: print Argo CD instance existence info"
  ansible.builtin.debug:
    msg: >-
      Default Argo CD instance '{{ ocp_gitops_instance_name }}'
      in namespace '{{ ocp_gitops_instance_namespace }}' exists:
      {{ (ocp_gitops_argocd_info_check.resources | length) > 0 }}
  when: ansible_check_mode
  changed_when: false

###########################################################################
# 7) Wait for Argo CD server deployment to be available (stand up the server)
###########################################################################
- name: "Wait for Argo CD server Deployment to be available"
  kubernetes.core.k8s_info:
    kubeconfig: "{{ ocp_kubeconfig }}"
    api_version: apps/v1
    kind: Deployment
    namespace: "{{ ocp_gitops_instance_namespace }}"
    name: "{{ ocp_gitops_instance_name }}-server"
  register: ocp_gitops_server_deploy
  retries: "{{ ocp_gitops_wait_retries }}"
  delay: "{{ ocp_gitops_wait_delay }}"
  until: >
    ocp_gitops_server_deploy.resources | length > 0 and
    (ocp_gitops_server_deploy.resources[0].status.readyReplicas | default(0) | int) > 0
  when: not ansible_check_mode

- name: "Check mode: get Argo CD server deployment (no wait)"
  kubernetes.core.k8s_info:
    kubeconfig: "{{ ocp_kubeconfig }}"
    api_version: apps/v1
    kind: Deployment
    namespace: "{{ ocp_gitops_instance_namespace }}"
    name: "{{ ocp_gitops_instance_name }}-server"
  register: ocp_gitops_server_deploy_check
  when: ansible_check_mode
  changed_when: false

###########################################################################
# 8) Route + login info
###########################################################################
- name: "Get Argo CD route"
  kubernetes.core.k8s_info:
    kubeconfig: "{{ ocp_kubeconfig }}"
    api_version: route.openshift.io/v1
    kind: Route
    namespace: "{{ ocp_gitops_instance_namespace }}"
    name: "{{ ocp_gitops_instance_name }}-server"
  register: ocp_gitops_route
  when: not ansible_check_mode

- name: "Show Argo CD URL and admin login hint"
  ansible.builtin.debug:
    msg:
      - "Argo CD Route: https://{{ ocp_gitops_route.resources[0].spec.host }}"
      - "Username: admin (default Red Hat GitOps instance)"
      - >-
        Password: check the secret '{{ ocp_gitops_instance_name }}-cluster'
        in namespace '{{ ocp_gitops_instance_namespace }}' (key: admin.password).
  when: not ansible_check_mode
